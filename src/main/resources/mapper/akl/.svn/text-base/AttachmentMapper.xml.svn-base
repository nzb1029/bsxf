<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.bsxf.common.repository.akl.AttachmentMybatisDao">
   <sql id="attachmentSql">
 select s.id,
		p.id as 'block.id',
		p.name as 'block.name',
		s.create_time as createTime,
		s.fileType,
		s.filename,
		s.filepath,
		s.field01,
		s.field02,
		s.field03
		from akl_attachment s 
		 left join akl_block p on p.id=s.block_id
		where 1=1 
	</sql>
	
	  <select id="getAllAttachment" parameterType="string" resultType="Attachment">
		<include refid="attachmentSql"/>
		 
	</select>
	
    <select id="getAttachment" parameterType="string" resultType="Attachment">
		<include refid="attachmentSql"/>
		  and  id=#{id}
	</select>
	
	<select id="findAttachmentByFilter" parameterType="Page" resultType="Attachment">
		<include refid="attachmentSql"/>
		<if test="filters.name!=null"> 
			 and p.name like '%' #{filters.name} '%'
		</if>
		<if test="filters.blockId!=null"> 
			 and s.block_id = #{filters.blockId}
		</if>
		<if test="filters.fileType!=null"> 
			 and s.fileType = #{filters.fileType}
		</if>
		<if test="orderBy!=null">
	      order by ${orderBy} ${order}
	   </if>
	      limit #{start},#{pageSize}
	</select>
	
	<select id="findAttachmentCountByFilter" parameterType="Page" resultType="int">
	     select count(1) from (	
	     <include refid="attachmentSql"/>
		  	<if test="filters.name!=null"> 
			   and p.name like '%' #{filters.name} '%'
			</if>
			<if test="orderBy!=null">
		      order by ${orderBy} ${order}
		   </if>
	     )t
	</select>
	<insert id="saveAttachment" parameterType="Attachment">
		insert into akl_attachment (id,
			block_id,
			create_time,
			fileType,
			filename,
			filepath,
		    field01,
		    field02,
		    field03
		    ) 
		 values(#{id},
			#{block.id},
			#{createTime},
			#{fileType},
			#{filename},
			#{filepath},
		    #{field01},
		    #{field02},
		    #{field03}
			)
	</insert>
	<update id="updateAttachment" parameterType="Attachment">
		update akl_attachment set 
			block_id     = #{block.id},       
			create_time  = #{createTime},
			fileType     = #{fileType},  
			filename     = #{filename},  
			filepath     = #{filepath},        
			field01      = #{field01},      
			field02      = #{field02},      
			field03      = #{field03}    
		 where id=#{id} 
	</update>
	 <delete id="deleteAttachment" >
	    delete from   akl_attachment  where id in 
	  <foreach  item="item" index="index" collection="list"
     	 open="(" separator="," close=")">
       		 #{item}
  	 </foreach> 
	</delete>	
	
	 <delete id="deleteAttachmentWhen" parameterType="Attachment">
	    delete from akl_attachment where block_id=#{blockId} and fileType=#{fileType}
	    <if test="field01 !=null"> 
			   and field01 = #{field01}
		</if>
		and filename = #{filename}
	</delete>	
</mapper>